name: New Update the default manifest

on:
  push:
    branches: [ update_default_manifest ]
  # schedule:
  #   - cron: '*/5 * * * *'
  workflow_dispatch:

jobs:
  Update_default_manifest:
    name: Update default manifest
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Install Checkbox
        run: |
          sudo add-apt-repository ppa:checkbox-dev/beta
          sudo apt-get update -qq
          sudo apt-get install canonical-certification-client -qq -y
      - name: Checkout ce-oem-dut-checkbox-configuration
        uses: actions/checkout@v4
      - name: Get latest manifest and compare with the default manifest
        run: |
          TEST_PLAN="com.canonical.certification::client-cert-desktop-24-04"
          NEW_MANIFEST="/tmp/new.json"
          ORIG_MANIFEST="./pc/default/manifest.json"
          python3 ./utils/manifest_get_compare.py --test_plan="$TEST_PLAN" --new_manifest="$NEW_MANIFEST" --orig_manifest="$ORIG_MANIFEST"
          if [ $? -eq 0 ]; then
            cp "$NEW_MANIFEST" "$ORIG_MANIFEST"
          else
            echo "No manifest changes being found."
          fi
      - name: GIT commit and push all changed files
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git diff
          if [ $? -eq 0 ]; then
            echo "no change"
            exit 0
          else
            git config user.name "${{ github.actor }}"
            git config user.email "${{ github.actor_id }}+${{ github.actor }}@users.noreply.github.com"
            git commit -a -m "update default manifest for pc"
            git push
            echo "new commit finished"
            exit 0